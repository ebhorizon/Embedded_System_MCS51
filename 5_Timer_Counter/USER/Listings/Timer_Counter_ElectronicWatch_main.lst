C51 COMPILER V9.57.0.0   TIMER_COUNTER_ELECTRONICWATCH_MAIN                                06/12/2020 14:09:56 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE TIMER_COUNTER_ELECTRONICWATCH_MAIN
OBJECT MODULE PLACED IN ..\OBJ\Timer_Counter_ElectronicWatch_main.obj
COMPILER INVOKED BY: e:\Keil_v5\C51\BIN\C51.EXE Timer_Counter_ElectronicWatch_main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\
                    -HARDWARE) DEBUG OBJECTEXTEND PRINT(.\Listings\Timer_Counter_ElectronicWatch_main.lst) OBJECT(..\OBJ\Timer_Counter_Electr
                    -onicWatch_main.obj)

line level    source

   1          /* 简易电子表 */
   2          
   3          #include <reg52.h>
   4          #include "74xx138.h"
   5          
   6          // 定义常用类型
   7          #ifndef u8
              #define u8 unsigned char
              #endif
  10          #ifndef u16
              #define u16 unsigned int
              #endif
  13          #ifndef u32
  14          #define u32 unsigned long
  15          #endif
  16          
  17          #define SEG_SEL P0                                      // 段选引脚
  18          
  19          //--下面两个宏定义便于调试--//
  20          #define TIMING                  50000           // 定时器的计时时间，默认为50ms(50000)
  21          #define TIMING_COUNT    20                      // 定时器的计时个数，默认为20
  22          
  23          //--共阴数码管段选，从0到9--//
  24          u8 code segCC_SegSel[10] = {0x3f, 0x06, 0x5b, 0x4f, 0x66, 0x6d, 0x7d, 0x07, 0x7f, 0x6f};
  25          //--数码管显示数据，00-00-00--//
  26          u8 DisplayCode[8]        = {0x3f, 0x3f, 0x40, 0x3f, 0x3f, 0x40, 0x3f, 0x3f};
  27          //--存储时间戳的变量--//
  28          u32 timestamp  = 0;
  29          
  30          void Delay1ms(u16 n)
  31          {
  32   1          u8 i, j;
  33   1          for(i = 0; i < n; i++)
  34   1                      for(j = 0; j < 125; j++);
  35   1      }
  36          
  37          void SegDisplay()
  38          {         
  39   1              u8 i;
  40   1              
  41   1              for(i = 0; i < 8; i++)
  42   1              {
  43   2                      _74XX138_SetLow(i);
  44   2                      SEG_SEL = DisplayCode[i];
  45   2                      Delay1ms(1);
  46   2                      
  47   2                      // 数码管消隐
  48   2                      SEG_SEL = 0x00;
  49   2              }
  50   1      }
  51          
  52          void DisplayCode_Update()
  53          {
C51 COMPILER V9.57.0.0   TIMER_COUNTER_ELECTRONICWATCH_MAIN                                06/12/2020 14:09:56 PAGE 2   

  54   1              u8 disHour   = timestamp / 60 / 60;
  55   1              u8 disMinute = timestamp / 60 % 60;
  56   1              u8 disSecond = timestamp % 60;
  57   1              
  58   1              DisplayCode[0] = segCC_SegSel[disHour   / 10];
  59   1              DisplayCode[1] = segCC_SegSel[disHour   % 10];
  60   1              DisplayCode[3] = segCC_SegSel[disMinute / 10];
  61   1              DisplayCode[4] = segCC_SegSel[disMinute % 10];
  62   1              DisplayCode[6] = segCC_SegSel[disSecond / 10];
  63   1              DisplayCode[7] = segCC_SegSel[disSecond % 10];
  64   1      }
  65          
  66          void Timer0Init()
  67          {
  68   1              /* 定时器0，工作方式1，或运算防止移植的时候影响其他定时器
  69   1                 方式1：16位加1计数器 */
  70   1              TMOD |= 0x01;
  71   1              
  72   1              // 打开定时器0
  73   1              TR0 = 1;
  74   1              
  75   1              /* 1. 使用12MHz晶振，时钟周期为1/12us，机器周期为(12 * 1 / 12) = 1us
  76   1                 2. 计数50ms = 50000us
  77   1                 3. TH = (2^16 - 50000) / (2^8) = 15536 / 256
  78   1                 4. TL = (2^16 - 50000) % (2^8) = 15536 % 256
  79   1                 5. 1s = 1000ms = 20 * 50ms */
  80   1              TH0 = (65536 - TIMING) / 256;
  81   1              TL0 = (65536 - TIMING) % 256;
  82   1              
  83   1              // 定时器0中断和总中断开关打开
  84   1              ET0 = 1;
  85   1              EA  = 1;
  86   1      }
  87          
  88          void main()
  89          {
  90   1              Timer0Init();
  91   1              
  92   1              while(1)
  93   1              {
  94   2                      SegDisplay();
  95   2                      DisplayCode_Update();
  96   2          }
  97   1      }
  98          
  99          void Timer0() interrupt 1
 100          {
 101   1              // 1s需要记录20个50ms
 102   1              static u8 tCount = 0;
 103   1              
 104   1              // 定时器0高低位的赋值
 105   1              TH0 = (65536 - TIMING) / 256;
 106   1              TL0 = (65536 - TIMING) % 256;
 107   1              
 108   1              // 累加并判断是否1s
 109   1              if(++tCount == TIMING_COUNT)
 110   1              {
 111   2                      // 累加并判断，时间为24-00-00 = 86400时清零
 112   2                      if(++timestamp == 86400) timestamp = 0;
 113   2                      // 重置1s计数
 114   2                      tCount = 0;
 115   2              }
C51 COMPILER V9.57.0.0   TIMER_COUNTER_ELECTRONICWATCH_MAIN                                06/12/2020 14:09:56 PAGE 3   

 116   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    320    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
